name: Build Kernel

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Update and install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git base-devel nasm xorriso grub-pc-bin mtools

      - name: Enable multilib and install 32-bit toolchain
        run: |
          # Ensure multilib is enabled for gcc-multilib if not already
          if ! grep -q "^\[multilib\]" /etc/apt/sources.list; then
            echo -e "\n[multilib]\nInclude = /etc/apt/sources.list" | sudo tee -a /etc/apt/sources.list
          fi
          sudo apt-get update
          sudo apt-get install -y gcc-multilib

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Kernel and ISO
        run: |
          cd code/src
          chmod +x build.sh
          ./build.sh

      - name: Upload Kernel Binary
        uses: actions/upload-artifact@v4
        with:
          name: kernel-binary
          path: code/kernel.bin

      - name: Upload Kernel ISO
        uses: actions/upload-artifact@v4
        with:
          name: kernel-iso
          path: code/kernel.iso
